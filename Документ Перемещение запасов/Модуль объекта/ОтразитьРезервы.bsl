// +++ Инфостарт 09.08.2021 Изменение механизма формирования резервов для хранения истории изменения движений
// Формирование движений перемещено в модуль менеджера. Движения прихода объединяются с расходом с вычетом количества
Процедура ОтразитьРезервы(ДополнительныеСвойства, Движения, Отказ);
	
	// +++ Инфостарт #2507 23.08.2021
	//Если Отказ ИЛИ ЭтотОбъект.ВидОперации <> Перечисления.ВидыОперацийПеремещениеЗапасов.асПередачаВРемонт
	//		ИЛИ ТипЗнч(ЭтотОбъект.ДокументОснование) <> Тип("ДокументСсылка.асЗаказНаряд") Тогда
	Если Отказ ИЛИ (ЭтотОбъект.ВидОперации <> Перечисления.ВидыОперацийПеремещениеЗапасов.асПередачаВРемонт
			И ТипЗнч(ЭтотОбъект.ДокументОснование) <> Тип("ДокументСсылка.асЗаказНаряд") И НЕ дмОтгрузкаНаСобственныеСклады) Тогда
	// --- Инфостарт #2507 23.08.2021
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЭтотОбъект.ДокументОснование) И ЭтотОбъект.ДокументОснование.Дата < '20210801' Тогда
		Возврат;
	КонецЕсли;
	
	ДвиженияРезервы = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаРезервы;
	
	// Удаление движений прихода при помощи объединения их с движениями расхода
	Если ДвиженияРезервы.Количество() > 0 Тогда
		
		МассивУдаляемыхСтрок = Новый Массив;
		
		Для каждого СтрокаДвижения Из ДвиженияРезервы Цикл
			Если СтрокаДвижения.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
				
				ПараметрыОтбораСтрок = Новый Структура;
				ПараметрыОтбораСтрок.Вставить("ВидДвижения",        ВидДвиженияНакопления.Расход);
				ПараметрыОтбораСтрок.Вставить("Организация",        СтрокаДвижения.Организация);
				ПараметрыОтбораСтрок.Вставить("Номенклатура",       СтрокаДвижения.Номенклатура);
				ПараметрыОтбораСтрок.Вставить("Характеристика",     СтрокаДвижения.Характеристика);
				ПараметрыОтбораСтрок.Вставить("СтруктурнаяЕдиница", СтрокаДвижения.СтруктурнаяЕдиница);
				ПараметрыОтбораСтрок.Вставить("асЗаказНаряд",       СтрокаДвижения.асЗаказНаряд);
				
				НайденныеСтроки = ДвиженияРезервы.НайтиСтроки(ПараметрыОтбораСтрок);
				
				КоличествоПриход = СтрокаДвижения.Количество;
				
				КоличествоНайденныхСтрок = НайденныеСтроки.Количество();
				
				Для Сч = 1 По КоличествоНайденныхСтрок Цикл
					
					ТекущаяСтрока = НайденныеСтроки[КоличествоНайденныхСтрок - Сч];
					
					Если ТекущаяСтрока.Количество >= КоличествоПриход И КоличествоПриход > 0 Тогда
						
						ТекущаяСтрока.Количество = ТекущаяСтрока.Количество - КоличествоПриход;
						КоличествоПриход = 0;
						
						МассивУдаляемыхСтрок.Добавить(СтрокаДвижения);
						
					ИначеЕсли ТекущаяСтрока.Количество < КоличествоПриход И КоличествоПриход > 0 Тогда
						
						КоличествоПриход = КоличествоПриход - ТекущаяСтрока.Количество;
						ТекущаяСтрока.Количество = 0;
						
					КонецЕсли;
					
					Если ТекущаяСтрока.Количество = 0 Тогда
						МассивУдаляемыхСтрок.Добавить(ТекущаяСтрока);
					КонецЕсли;
					
				КонецЦикла;
				
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого УдаляемаяСтрока Из МассивУдаляемыхСтрок Цикл
			ДвиженияРезервы.Удалить(УдаляемаяСтрока);
		КонецЦикла;
		
		Движения.RMS_РезервыПодЗаказНаряд.Записывать = Истина;
		Движения.RMS_РезервыПодЗаказНаряд.Загрузить(ДвиженияРезервы);
		
	КонецЕсли;
	
	// +++ Инфостарт #2666 12.08.2021
	// Проверка наличия прихода резерва по заказ-наряду. Если он отсутствует,то движения по резервам формировать не нужно
	Запрос = Новый Запрос;
	Запрос.Текст =
	
	// КШР - М.В. - Вячеслав Голев ---->
	// +++ Инфостарт Васильев А.Э. 10.11.2021
	"ВЫБРАТЬ
	|	Движения.Номенклатура КАК Номенклатура   
	|ПОМЕСТИТЬ ВТ_ДвиженияПоРезервам
	|ИЗ 
	|	&Движения КАК Движения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|";
	
	Запрос.Текст = Запрос.Текст + 
	// --- Инфостарт Васильев А.Э. 10.11.2021

	"ВЫБРАТЬ
	|RMS_РезервыПодЗаказНаряд.Номенклатура КАК Номенклатура,
	|RMS_РезервыПодЗаказНаряд.Характеристика КАК Характеристика,
	|RMS_РезервыПодЗаказНаряд.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|RMS_РезервыПодЗаказНаряд.Количество КАК КоличествоОстаток
	|ИЗ
	|РегистрНакопления.RMS_РезервыПодЗаказНаряд КАК RMS_РезервыПодЗаказНаряд
	// +++ Инфостарт Васильев А.Э. 10.11.2021
	//|ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПеремещениеЗапасов.Запасы КАК ПеремещениеЗАпасы
	//|ПО (RMS_РезервыПодЗаказНаряд.Номенклатура = ПеремещениеЗАпасы.Номенклатура)
	//|И (ПеремещениеЗАпасы.Ссылка = &Ссылка)
	// --- Инфостарт Васильев А.Э. 10.11.2021
	|ГДЕ
	// +++ Инфостарт #2507 23.08.2021
	//|RMS_РезервыПодЗаказНаряд.асЗаказНаряд = &ЗаказНаряд
	|RMS_РезервыПодЗаказНаряд.асЗаказНаряд В (&ЗаказНаряд)
	// +++ Инфостарт Васильев А.Э. 10.11.2021
	|И RMS_РезервыПодЗаказНаряд.Номенклатура В 
	|	(ВЫБРАТЬ
	|		ВТ_ДвиженияПоРезервам.Номенклатура	
	|   ИЗ
	|		ВТ_ДвиженияПоРезервам КАК ВТ_ДвиженияПоРезервам)
	// --- Инфостарт Васильев А.Э. 10.11.2021
	// --- Инфостарт #2507 23.08.2021
	|И RMS_РезервыПодЗаказНаряд.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)";
	
	// +++ Инфостарт #2507 23.08.2021
	//Запрос.УстановитьПараметр("ЗаказНаряд", ДокументОснование);
	Запрос.УстановитьПараметр("ЗаказНаряд", ДвиженияРезервы.ВыгрузитьКолонку("асЗаказНаряд"));
	// --- Инфостарт #2507 23.08.2021
	// +++ Инфостарт Васильев А.Э. 10.11.2021
	//Запрос.УстановитьПараметр("Ссылка", ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("Движения", ДвиженияРезервы);
	// --- Инфостарт Васильев А.Э. 10.11.2021
		
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаПриходов = РезультатЗапроса.Выгрузить();
	
	Если ТаблицаПриходов.Количество() = 0 Тогда
		
		ДвиженияРезервы.Очистить();
		Движения.RMS_РезервыПодЗаказНаряд.Записывать = Истина;
		Движения.RMS_РезервыПодЗаказНаряд.Загрузить(ДвиженияРезервы);
		
		Возврат;
		
	КонецЕсли;
	
	// Проверка наличия товара на складе. Получение данных находится в модуле менеджера
	Для каждого СтрокаДвижения Из ДвиженияРезервы Цикл
		//// КШР - М.В. - заглушка 12.08.2021 ---->  Не дает выдать Собственный товар в ЗН
		//
		//ПВХ = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию("Давальческий склад (Структурные единицы)");
		//ТипИстДав = Ложь;
		//Для Каждого Стр из ЭтотОбъект.СтруктурнаяЕдиница.ДополнительныеРеквизиты Цикл
		//	Если Стр.Свойство = ПВХ Тогда
		//		ТипИстДав = Стр.Значение;
		//		Прервать;
		//	КонецЕсли;	
		//КонецЦикла;
		//// КШР - М.В. <----
		
		Если Ложь И СтрокаДвижения.НедостатокНаСкладе Тогда        // и ТипИстДав - КШР - М.В. - заглушка   //+++ Герасимов отключина проверка [13/08/2021 11:55]   			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрШаблон(
				НСтр("ru = 'По заказ-наряду %1 недостаточно резерва номенклатуры %2 %3 %4 на складе %5 для перемещения'"),
				ДокументОснование,
				СтрокаДвижения.Номенклатура,
				?(ЗначениеЗаполнено(СтрокаДвижения.Характеристика), "с характеристикой",           ""),
				?(ЗначениеЗаполнено(СтрокаДвижения.Характеристика), СтрокаДвижения.Характеристика, ""),
				СтрокаДвижения.СтруктурнаяЕдиница));
			
			Отказ = Истина;
			
		КонецЕсли;
		
	КонецЦикла;
	// --- Инфостарт #2666 12.08.2021
	
	// Проверка корректности выбранного склада в строке запасов
	Запрос = Новый Запрос;  
	
	// +++ Инфостарт 13.12.2021 Добавление учета аналогов
	Если НЕ ПолучитьФункциональнуюОпцию("дмИспользоватьАналоги") Тогда
	// --- Инфостарт 13.12.2021
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ДвиженияРезервы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|	ДвиженияРезервы.Номенклатура КАК Номенклатура,
		|	ДвиженияРезервы.Характеристика КАК Характеристика,
		|	ДвиженияРезервы.НедостатокНаСкладе КАК НедостатокНаСкладе,
		|	ДвиженияРезервы.Количество КАК Количество
		|ПОМЕСТИТЬ ВТ_ДвиженияРезервы
		|ИЗ
		|	&ДвиженияРезервы КАК ДвиженияРезервы
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ДвиженияРезервы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|	ВТ_ДвиженияРезервы.Номенклатура КАК Номенклатура,
		|	ВТ_ДвиженияРезервы.Характеристика КАК Характеристика,
		|	МАКСИМУМ(ВТ_ДвиженияРезервы.НедостатокНаСкладе) КАК НедостатокНаСкладе,
		|	СУММА(ВТ_ДвиженияРезервы.Количество) КАК Количество
		|ПОМЕСТИТЬ ВТ_ДвиженияРезервыГруп
		|ИЗ
		|	ВТ_ДвиженияРезервы КАК ВТ_ДвиженияРезервы
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_ДвиженияРезервы.СтруктурнаяЕдиница,
		|	ВТ_ДвиженияРезервы.Номенклатура,
		|	ВТ_ДвиженияРезервы.Характеристика
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Запасы.итсСтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|	Запасы.Номенклатура КАК Номенклатура,
		|	Запасы.Характеристика КАК Характеристика,
		|	СУММА(Запасы.Количество) КАК Количество
		|ПОМЕСТИТЬ ВТ_ДанныеДок
		|ИЗ
		|	Документ.ПеремещениеЗапасов.Запасы КАК Запасы
		|ГДЕ
		|	Запасы.Ссылка = &Ссылка
		|	И Запасы.Количество > 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Запасы.итсСтруктурнаяЕдиница,
		|	Запасы.Характеристика,
		|	Запасы.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	RMS_РезервыПодЗаказНаряд.Номенклатура КАК Номенклатура,
		|	RMS_РезервыПодЗаказНаряд.Характеристика КАК Характеристика,
		|	RMS_РезервыПодЗаказНаряд.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|	RMS_РезервыПодЗаказНаряд.КоличествоОстаток КАК КоличествоОстаток
		|ПОМЕСТИТЬ ВТ_ОстаткиРезерва
		|ИЗ
		|	РегистрНакопления.RMS_РезервыПодЗаказНаряд.Остатки(, асЗаказНаряд = &ЗаказНаряд) КАК RMS_РезервыПодЗаказНаряд
		|ГДЕ
		|	RMS_РезервыПодЗаказНаряд.КоличествоОстаток > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ОстаткиРезерва.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница
		|ИЗ
		|	ВТ_ОстаткиРезерва КАК ВТ_ОстаткиРезерва
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_ОстаткиРезерва.СтруктурнаяЕдиница
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ДанныеДок.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|	ВТ_ДанныеДок.Номенклатура КАК Номенклатура,
		|	ВТ_ДанныеДок.Характеристика КАК Характеристика,
		|	ВТ_ДанныеДок.Количество КАК КоличествоВДокументе,
		|	МАКСИМУМ(ЕСТЬNULL(ВТ_ДвиженияРезервыГруп.НедостатокНаСкладе, ЛОЖЬ)) КАК НедостатокНаСкладе,
		|	СУММА(ЕСТЬNULL(ВТ_ДвиженияРезервыГруп.Количество, 0)) КАК КоличествоВДвижениях,
		|	СУММА(ЕСТЬNULL(ВТ_ОстаткиРезерва.КоличествоОстаток, 0)) КАК КоличествоОстаток,
		|	МАКСИМУМ(ЕСТЬNULL(ВТ_ОстаткиРезерваСклады.СтруктурнаяЕдиница, ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяСсылка))) КАК СкладСОстатком
		|ИЗ
		|	ВТ_ДанныеДок КАК ВТ_ДанныеДок
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДвиженияРезервыГруп КАК ВТ_ДвиженияРезервыГруп
		|		ПО ВТ_ДанныеДок.СтруктурнаяЕдиница = ВТ_ДвиженияРезервыГруп.СтруктурнаяЕдиница
		|			И ВТ_ДанныеДок.Номенклатура = ВТ_ДвиженияРезервыГруп.Номенклатура
		|			И ВТ_ДанныеДок.Характеристика = ВТ_ДвиженияРезервыГруп.Характеристика
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ОстаткиРезерва КАК ВТ_ОстаткиРезерва
		|		ПО ВТ_ДанныеДок.СтруктурнаяЕдиница = ВТ_ОстаткиРезерва.СтруктурнаяЕдиница
		|			И ВТ_ДанныеДок.Номенклатура = ВТ_ОстаткиРезерва.Номенклатура
		|			И ВТ_ДанныеДок.Характеристика = ВТ_ОстаткиРезерва.Характеристика
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ОстаткиРезерва КАК ВТ_ОстаткиРезерваСклады
		|		ПО ВТ_ДанныеДок.Номенклатура = ВТ_ОстаткиРезерваСклады.Номенклатура
		|			И ВТ_ДанныеДок.Характеристика = ВТ_ОстаткиРезерваСклады.Характеристика
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_ДанныеДок.СтруктурнаяЕдиница,
		|	ВТ_ДанныеДок.Номенклатура,
		|	ВТ_ДанныеДок.Характеристика,
		|	ВТ_ДанныеДок.Количество";
	
	// +++ Инфостарт 13.12.2021 Добавление учета аналогов
	Иначе
		
		Запрос.Текст =
			"ВЫБРАТЬ
			|	ДвиженияРезервы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	ДвиженияРезервы.Номенклатура КАК Номенклатура,
			|	ДвиженияРезервы.Характеристика КАК Характеристика,
			|	ДвиженияРезервы.НедостатокНаСкладе КАК НедостатокНаСкладе,
			|	ДвиженияРезервы.Количество КАК Количество
			|ПОМЕСТИТЬ ВТ_ДвиженияРезервы
			|ИЗ
			|	&ДвиженияРезервы КАК ДвиженияРезервы
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВТ_ДвиженияРезервы.Номенклатура КАК Номенклатура
			|ПОМЕСТИТЬ ВТ_ТоварыЗН
			|ИЗ
			|	ВТ_ДвиженияРезервы КАК ВТ_ДвиженияРезервы
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_ДвиженияРезервы.Номенклатура
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			// Поиск оригиналов по аналогам номенклатуры из заказ-наряда
			|ВЫБРАТЬ
			|	ВТ_ТоварыЗН.Номенклатура КАК Номенклатура,
			|	МАКСИМУМ(ЕСТЬNULL(АналогиНоменклатуры.Номенклатура, ВТ_ТоварыЗН.Номенклатура)) КАК НоменклатураОригинал
			|ПОМЕСТИТЬ ВТ_НайденныеОригиналы
			|ИЗ
			|	ВТ_ТоварыЗН КАК ВТ_ТоварыЗН
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналогиНоменклатуры КАК АналогиНоменклатуры
			|		ПО ВТ_ТоварыЗН.Номенклатура = АналогиНоменклатуры.Аналог
			|ГДЕ
			|	ВТ_ТоварыЗН.Номенклатура.дмЭтоАналог
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_ТоварыЗН.Номенклатура
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			// Объединение найденных оригиналов с оригиналами товаров из документа
			|ВЫБРАТЬ
			|	ВТ_ТоварыЗН.Номенклатура КАК Номенклатура,
			|	ВТ_ТоварыЗН.Номенклатура КАК НоменклатураОригинал
			|ИЗ
			|	ВТ_ТоварыЗН КАК ВТ_ТоварыЗН
			|ГДЕ
			|	НЕ ВТ_ТоварыЗН.Номенклатура.дмЭтоАналог
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_ТоварыЗН.Номенклатура
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			// Получение аналогов по найденным оригиналам (оригинал-аналог)
			|ВЫБРАТЬ
			|	ВТ_НайденныеОригиналы.НоменклатураОригинал КАК Номенклатура,
			|	АналогиНоменклатуры.Аналог КАК НоменклатураАналог
			|ПОМЕСТИТЬ ВТ_ТоварыОригиналы
			|ИЗ
			|	ВТ_НайденныеОригиналы КАК ВТ_НайденныеОригиналы
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналогиНоменклатуры КАК АналогиНоменклатуры
			|		ПО ВТ_НайденныеОригиналы.НоменклатураОригинал = АналогиНоменклатуры.Номенклатура
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			// Добавление строк оригинал-оригинал для получения остатков
			|ВЫБРАТЬ
			|	ВТ_НайденныеОригиналы.НоменклатураОригинал,
			|	ВТ_НайденныеОригиналы.НоменклатураОригинал
			|ИЗ
			|	ВТ_НайденныеОригиналы КАК ВТ_НайденныеОригиналы
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			// Группировка всех строк оригинал-аналог для исключения дублей
			|ВЫБРАТЬ
			|	ВТ_ТоварыОригиналы.Номенклатура КАК Номенклатура,
			|	ВТ_ТоварыОригиналы.НоменклатураАналог КАК НоменклатураАналог
			|ПОМЕСТИТЬ ВТ_ВсеОригиналыАналоги
			|ИЗ
			|	ВТ_ТоварыОригиналы КАК ВТ_ТоварыОригиналы
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_ТоварыОригиналы.Номенклатура,
			|	ВТ_ТоварыОригиналы.НоменклатураАналог
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВТ_ДвиженияРезервы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	ЕСТЬNULL(ВТ_НайденныеОригиналы.НоменклатураОригинал, ВТ_ДвиженияРезервы.Номенклатура) КАК Номенклатура,
			|	МАКСИМУМ(ВТ_ДвиженияРезервы.НедостатокНаСкладе) КАК НедостатокНаСкладе,
			|	СУММА(ВТ_ДвиженияРезервы.Количество) КАК Количество
			|ПОМЕСТИТЬ ВТ_ДвиженияРезервыГруп
			|ИЗ
			|	ВТ_ДвиженияРезервы КАК ВТ_ДвиженияРезервы
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_НайденныеОригиналы КАК ВТ_НайденныеОригиналы
			|		ПО ВТ_ДвиженияРезервы.Номенклатура = ВТ_НайденныеОригиналы.Номенклатура
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_ДвиженияРезервы.СтруктурнаяЕдиница,
			|	ЕСТЬNULL(ВТ_НайденныеОригиналы.НоменклатураОригинал, ВТ_ДвиженияРезервы.Номенклатура)
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Запасы.итсСтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	ЕСТЬNULL(ВТ_НайденныеОригиналы.НоменклатураОригинал, Запасы.Номенклатура) КАК Номенклатура,
			|	СУММА(Запасы.Количество) КАК Количество
			|ПОМЕСТИТЬ ВТ_ДанныеДок
			|ИЗ
			|	Документ.ПеремещениеЗапасов.Запасы КАК Запасы
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_НайденныеОригиналы КАК ВТ_НайденныеОригиналы
			|		ПО Запасы.Номенклатура = ВТ_НайденныеОригиналы.Номенклатура
			|ГДЕ
			|	Запасы.Ссылка = &Ссылка
			|	И Запасы.Количество > 0
			|
			|СГРУППИРОВАТЬ ПО
			|	Запасы.итсСтруктурнаяЕдиница,
			|	ЕСТЬNULL(ВТ_НайденныеОригиналы.НоменклатураОригинал, Запасы.Номенклатура)
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ЕСТЬNULL(ВТ_НайденныеОригиналы.НоменклатураОригинал, RMS_РезервыПодЗаказНаряд.Номенклатура) КАК Номенклатура,
			|	RMS_РезервыПодЗаказНаряд.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	СУММА(RMS_РезервыПодЗаказНаряд.КоличествоОстаток) КАК КоличествоОстаток
			|ПОМЕСТИТЬ ВТ_ОстаткиРезерва
			|ИЗ
			|	РегистрНакопления.RMS_РезервыПодЗаказНаряд.Остатки(, асЗаказНаряд = &ЗаказНаряд) КАК RMS_РезервыПодЗаказНаряд
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_НайденныеОригиналы КАК ВТ_НайденныеОригиналы
			|		ПО RMS_РезервыПодЗаказНаряд.Номенклатура = ВТ_НайденныеОригиналы.Номенклатура
			|ГДЕ
			|	RMS_РезервыПодЗаказНаряд.КоличествоОстаток > 0
			|
			|СГРУППИРОВАТЬ ПО
			|	RMS_РезервыПодЗаказНаряд.СтруктурнаяЕдиница,
			|	ЕСТЬNULL(ВТ_НайденныеОригиналы.НоменклатураОригинал, RMS_РезервыПодЗаказНаряд.Номенклатура)
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВТ_ОстаткиРезерва.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница
			|ИЗ
			|	ВТ_ОстаткиРезерва КАК ВТ_ОстаткиРезерва
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_ОстаткиРезерва.СтруктурнаяЕдиница
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВТ_ДанныеДок.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	ВТ_ДанныеДок.Номенклатура КАК Номенклатура,
			|	ВТ_ДанныеДок.Количество КАК КоличествоВДокументе,
			|	МАКСИМУМ(ЕСТЬNULL(ВТ_ДвиженияРезервыГруп.НедостатокНаСкладе, ЛОЖЬ)) КАК НедостатокНаСкладе,
			|	СУММА(ЕСТЬNULL(ВТ_ДвиженияРезервыГруп.Количество, 0)) КАК КоличествоВДвижениях,
			|	СУММА(ЕСТЬNULL(ВТ_ОстаткиРезерва.КоличествоОстаток, 0)) КАК КоличествоОстаток,
			|	МАКСИМУМ(ЕСТЬNULL(ВТ_ОстаткиРезерваСклады.СтруктурнаяЕдиница, ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяСсылка))) КАК СкладСОстатком
			|ИЗ
			|	ВТ_ДанныеДок КАК ВТ_ДанныеДок
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДвиженияРезервыГруп КАК ВТ_ДвиженияРезервыГруп
			|		ПО ВТ_ДанныеДок.СтруктурнаяЕдиница = ВТ_ДвиженияРезервыГруп.СтруктурнаяЕдиница
			|			И ВТ_ДанныеДок.Номенклатура = ВТ_ДвиженияРезервыГруп.Номенклатура
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ОстаткиРезерва КАК ВТ_ОстаткиРезерва
			|		ПО ВТ_ДанныеДок.СтруктурнаяЕдиница = ВТ_ОстаткиРезерва.СтруктурнаяЕдиница
			|			И ВТ_ДанныеДок.Номенклатура = ВТ_ОстаткиРезерва.Номенклатура
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ОстаткиРезерва КАК ВТ_ОстаткиРезерваСклады
			|		ПО ВТ_ДанныеДок.Номенклатура = ВТ_ОстаткиРезерваСклады.Номенклатура
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_ДанныеДок.СтруктурнаяЕдиница,
			|	ВТ_ДанныеДок.Номенклатура,
			|	ВТ_ДанныеДок.Количество";
		
	КонецЕсли;
	// --- Инфостарт 13.12.2021
	
	Запрос.УстановитьПараметр("Ссылка",          Ссылка);
	Запрос.УстановитьПараметр("ЗаказНаряд",      ДокументОснование);
	Запрос.УстановитьПараметр("ДвиженияРезервы", ДвиженияРезервы);
	
	// +++ Инфостарт #2666 12.08.2021
	//РезультатЗапроса = Запрос.Выполнить();
	//ВыборкаДЗ = РезультатЗапроса.Выбрать();
	//
	//Пока ВыборкаДЗ.Следующий() Цикл
	//	
	//	// Если уже есть движения или остатки по товару на складе, то пропускаем строку
	//	Если (ВыборкаДЗ.КоличествоВДвижениях > 0 ИЛИ ВыборкаДЗ.КоличествоОстаток > 0)
	//			И ВыборкаДЗ.КоличествоВДокументе > 0 Тогда
	//		Продолжить;
	//	КонецЕсли;
	//	
	//	//Если остатков нет, то сообщаем на каком складе они имеются
	//	Если ЗначениеЗаполнено(ВыборкаДЗ.СкладСОстатком) Тогда
	//		
	//		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрШаблон(
	//			НСтр("ru = 'По заказ-наряду %1 не обнаружен резерв номенклатуры %2 %3 %4 на складе %5. Резерв находится на складе %6'"),
	//			ДокументОснование,
	//			ВыборкаДЗ.Номенклатура,
	//			?(ЗначениеЗаполнено(ВыборкаДЗ.Характеристика), "с характеристикой",      ""),
	//			?(ЗначениеЗаполнено(ВыборкаДЗ.Характеристика), ВыборкаДЗ.Характеристика, ""),
	//			ВыборкаДЗ.СтруктурнаяЕдиница,
	//			ВыборкаДЗ.СкладСОстатком));
	//		
	//		Отказ = Истина;
	//		
	//	КонецЕсли;
	//	
	//КонецЦикла;
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	// Формирование строки складов для сообщения
	// +++ Инфостарт 13.12.2021
	//ТаблицаСкладов = РезультатЗапроса[4].Выгрузить();
	ТаблицаСкладов = РезультатЗапроса[РезультатЗапроса.Количество() - 2].Выгрузить();
	// --- Инфостарт 13.12.2021
	
	МассивСкладов = Новый Массив;
	
	Для Каждого НайденныйСклад Из ТаблицаСкладов Цикл
		МассивСкладов.Добавить(НайденныйСклад.СтруктурнаяЕдиница);
	КонецЦикла;
	
	СтрокаСкладов = СтрСоединить(МассивСкладов, ", ");
	
	// Проверка, нужно ли выводить сообщение о нахождении резерва на других складах
	ВыводСообщения = Ложь;
	
	// +++ Инфостарт 13.12.2021
	//ВыборкаДЗ = РезультатЗапроса[5].Выбрать();
	ВыборкаДЗ = РезультатЗапроса[РезультатЗапроса.Количество() - 1].Выбрать();
	// --- Инфостарт 13.12.2021
	
	Пока ВыборкаДЗ.Следующий() Цикл
		Если Ложь И ЗначениеЗаполнено(СтрокаСкладов) И ВыборкаДЗ.КоличествоОстаток <= 0 И ВыборкаДЗ.НедостатокНаСкладе
				И ВыборкаДЗ.КоличествоВДокументе > 0 Тогда //+++ Герасимов отключина проверка [13/08/2021 12:07]
			
			ВыводСообщения = Истина;
			Отказ = Истина;
			
		КонецЕсли;
	КонецЦикла;
	
	Если ВыводСообщения Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрШаблон(
			НСтр("ru = 'Резерв запчастей по заказ-наряду %1 находится на складах %2'"),
			ДокументОснование,
			СтрокаСкладов));
	КонецЕсли;
	// --- Инфостарт #2666 12.08.2021
	
	// +++ Инфостарт 29.09.2021 Добавление проверки очередности списания резервов
	Если ДвиженияРезервы.Количество() > 0 И ЭтотОбъект.ВидОперации = Перечисления.ВидыОперацийПеремещениеЗапасов.асПередачаВРемонт Тогда
		
		ТекстСообщения = ПроверитьНаличиеРезервов(ДвиженияРезервы);
		
		Если ТекстСообщения <> "" Тогда
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Отказ = Истина;
			
		КонецЕсли;
		
	КонецЕсли;
	// --- Инфостарт 29.09.2021
	
КонецПроцедуры

